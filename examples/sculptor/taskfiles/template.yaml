version: "3"

vars:
  TEMPLATE_DIR: "{{.DATA_DIR}}/template"

tasks:
  download:
    cmds:
      - pwd
      - wget --output-document="00-{{.COMPONENT}}.ply" "https://raw.githubusercontent.com/liblaf/sculptor/main/model/template/{{.COMPONENT}}.ply"
    generates:
      - 00-{{.COMPONENT}}.ply
    status:
      - test -s 00-{{.COMPONENT}}.ply
    requires:
      vars:
        - COMPONENT
        - DATA_DIR
        - TEMPLATE_DIR
    dir: "/{{.TEMPLATE_DIR}}"

  preprocess:
    cmds:
      - python "{{.CMD_DIR}}/template/{{.COMPONENT}}.py" "01-{{.COMPONENT}}.ply" "02-{{.COMPONENT}}.ply"
    deps:
      - download
    sources:
      - 00-{{.COMPONENT}}.ply
    generates:
      - 01-{{.COMPONENT}}.ply
    requires:
      vars:
        - CMD_DIR
        - COMPONENT
        - DATA_DIR
        - TEMPLATE_DIR
    dir: "/{{.TEMPLATE_DIR}}"

  refine:
    cmds:
      - cp --force --no-target-directory --verbose "01-{{.COMPONENT}}.ply" "02-{{.COMPONENT}}.ply"
      # - "false"
    deps:
      - preprocess
    sources:
      - 01-{{.COMPONENT}}.ply
    generates:
      - 02-{{.COMPONENT}}.ply
    status:
      - test "02-{{.COMPONENT}}.ply" -nt "01-{{.COMPONENT}}.ply"
    requires:
      vars:
        - COMPONENT
        - DATA_DIR
        - TEMPLATE_DIR
    dir: "/{{.TEMPLATE_DIR}}"
    method: timestamp

  mesh-fix:
    cmds:
      - MeshFix "02-{{.COMPONENT}}.ply" "03-{{.COMPONENT}}.ply"
    deps:
      - refine
    sources:
      - 02-{{.COMPONENT}}.ply
    generates:
      - 03-{{.COMPONENT}}.ply
    requires:
      vars:
        - COMPONENT
        - DATA_DIR
        - TEMPLATE_DIR
    dir: "/{{.TEMPLATE_DIR}}"

  landmarks:
    cmds:
      - 'echo "Annotate Landmarks: \"03-{{.COMPONENT}}.ply\""'
      - "false"
    deps:
      - mesh-fix
    sources:
      - 03-{{.COMPONENT}}.ply
    generates:
      - 03-{{.COMPONENT}}-landmarks.txt
    status:
      - test "03-{{.COMPONENT}}-landmarks.txt" -nt "03-{{.COMPONENT}}.ply"
    requires:
      vars:
        - COMPONENT
        - DATA_DIR
        - TEMPLATE_DIR
    dir: "/{{.TEMPLATE_DIR}}"
    method: timestamp
